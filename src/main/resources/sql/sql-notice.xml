<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="bitc.fullstack405.team2.notice.NoticeMapper">

    <!-- 공지사항 목록 -->
    <select id="selectNoticeList" resultType="bitc.fullstack405.team2.notice.NoticeDTO">
        SELECT
            n.notice_id, n.category, n.title, n.image_url, n.createdAt,
            n.start_date, n.end_date, n.hit_cnt,
            CASE
                WHEN c.name IS NOT NULL THEN c.name
                ELSE '전체'
            END AS name
        FROM
            notice_test n
            LEFT JOIN
            cafe c
        ON
            n.cafe_id = c.cafe_id
        WHERE
            n.deleted_yn = 'N'
        ORDER BY
            n.notice_id DESC
    </select>

    <!-- 공지사항 게시물 상세 -->
    <select id="selectNoticeDetail" parameterType="int" resultType="bitc.fullstack405.team2.notice.NoticeDTO">
        SELECT
            n.category, n.title, n.image_url, n.createdAt, n.hit_cnt,
            CASE
                WHEN c.name IS NOT NULL THEN c.name
                ELSE '전체'
            END AS name
        FROM
            notice_test n
            LEFT JOIN
            cafe c
        ON
            n.cafe_id = c.cafe_id
        WHERE
            n.notice_id = #{noticeId}
        AND
            n.deleted_yn = 'N'
    </select>

    <!-- name으로 cafe_id를 조회하는 쿼리 -->
    <select id="getCafeIdByName" parameterType="String" resultType="int">
        SELECT
            cafe_id
        FROM
            cafe
        WHERE
            name = #{name}
    </select>

    <!-- notice_test 테이블에 데이터를 삽입하는 쿼리 -->
    <insert id="insertNotice" parameterType="bitc.fullstack405.team2.notice.NoticeDTO">
        INSERT INTO notice_test
            (category, cafe_id, title, createdAt, start_date, end_date, image_url)
        VALUES
            (#{category}, #{cafeId}, #{title}, now(), NULLIF(#{startDate}, ''), NULLIF(#{endDate}, ''), #{imageUrl})
    </insert>

    <!-- 조회수 증가 -->
    <update id="updateHitCount" parameterType = "int">
        UPDATE
            notice_test
        SET
            hit_cnt = hit_cnt + 1
        WHERE
            notice_id = #{noticeId}
    </update>
</mapper>